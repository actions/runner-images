trigger:
  batch: true

variables:
 AZURE_SUB_ID: ${env:AZURE_SUBSCRIPTION_ID}
 GH_TOKEN: ${env:GITHUB_TOKEN}


stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    workspace:
      clean: all
    displayName: Build
    pool: vmss-windows

    steps:
    - powershell: |
        Write-Host $(GH_TOKEN)
        Write-Host $(GITHUB_TOKEN)
        Install-Module -Name Az -Scope CurrentUser -Repository PSGallery -Force -AllowClobber
        Import-Module .\helpers\GenerateResourcesAndImage.ps1
        GenerateResourcesAndImage -SubscriptionId 0fc6d504-3fba-461e-934e-25744d5c7f6c -ImageGenerationRepositoryRoot "$pwd" -ImageType windows2019 -AzureLocation "west US" -GithubFeedToken ${env:GITHUB_TOKEN} -ResourceGroupName "buildagents-$(Build.BuildId)"

        # Install-Module -Name Az -Scope CurrentUser -Repository PSGallery -Force -AllowClobber
        # Import-Module .\helpers\GenerateResourcesAndImage.ps1
        # GenerateResourcesAndImage -SubscriptionId $(AZURE_SUB_ID) -ImageGenerationRepositoryRoot "$pwd" -ImageType windows2019 -AzureLocation "west US" -GithubFeedToken $(GH_TOKEN) -ResourceGroupName "buildagents-$(Build.BuildId)"
      displayName: build resources
