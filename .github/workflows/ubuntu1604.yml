name: Ubuntu1604
on:
  pull_request:
    types: [labeled]

jobs:
  build:
    name: Ubuntu 1604
    runs-on: self-hosted
    if: github.event.label.name == 'test-ubuntu1604'

    steps:
      - name: Set build number
        shell: pwsh
        run: |
            $UniqueBuildNumber = date +%s
            echo ::set-env name=UniqueBuildNumber::$UniqueBuildNumber

      - name: Build VM
        working-directory: ./Images.CI
        shell: pwsh
        run: |
            build-image.ps1 -ResourcesNamePrefix $UniqueBuildNumber `
                            -ClientId ${{ secrets.CLIENT_ID }} `
                            -ClientSecret ${{ secrets.CLIENT_SECRET }}`
                            -Image ubuntu1604 `
                            -ResourceGroup ${{ secrets.AZURE_RESOURCE_GROUP }} `
                            -StorageAccount ${{ secrets.AZURE_STORAGE_ACCOUNT }} `
                            -SubscriptionId ${{ secrets.AZURE_SUBSCRIPTION }} `
                            -TenantId ${{ secrets.AZURE_TENANT }} `
                            -Location ${{ secrets.AZURE_LOCATION }} `
                            -VirtualNetworkName ${{ secrets.BUILD_AGENT_VNET_NAME }} `
                            -VirtualNetworkRG ${{ secrets.BUILD_AGENT_VNET_RESOURCE_GROUP }} `
                            -VirtualNetworkSubnet ${{ secrets.BUILD_AGENT_SUBNET_NAME }} `
                            -GitHubFeedToken ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up VM
        working-directory: ./Images.CI
        shell: pwsh
        run: cleanup.ps1 -ResourcesNamePrefix $UniqueBuildNumber `
                         -ClientId ${{ secrets.CLIENT_ID }} `
                         -ClientSecret ${{ secrets.CLIENT_SECRET }} `
                         -Image ubuntu1604 `
                         -SubscriptionId ${{ secrets.AZURE_SUBSCRIPTION }} `
                         -TenantId ${{ secrets.AZURE_TENANT }}