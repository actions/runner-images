name: Trigger Build workflow

on:
  workflow_call:
    inputs:
      image_type:
        required: true
        type: string

defaults:
  run:
    shell: pwsh

jobs:
  trigger-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Trigger Build workflow
        env:
          CI_PR_TOKEN: ${{ secrets.CI_PR_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          CI_REPO: ${{ vars.CI_REPO }}
        run: |
          Import-Module ./helpers/GitHubApi.psm1
          $gitHubApi = Get-GithubApi -Repository "${env:CI_REPO}" -AccessToken "${env:CI_PR_TOKEN}"

          $eventType = "trigger-${{ inputs.image_type }}-build"
          $clientPayload = @{
              pr_title                = "${env:PR_TITLE}"
              custom_repo             = "${{ github.event.pull_request.head.repo.full_name }}"
              custom_repo_commit_hash = "${{ github.event.pull_request.head.sha }}"
          }

          $gitHubApi.DispatchWorkflow($eventType, $clientPayload)

  wait-completion:
    runs-on: ubuntu-latest
    needs: trigger-workflow
    outputs:
      ci_workflow_run_id: ${{ steps.wait.outputs.ci_workflow_run_id }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Wait for workflow completion
        id: wait
        env:
          CI_PR_TOKEN: ${{ secrets.CI_PR_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          CI_REPO: ${{ vars.CI_REPO }}
        run: |
          $workflowFileName = $("{0}.yml" -f "${{ inputs.image_type }}").ToLower()
          ./helpers/WaitWorkflowCompletion.ps1 `
            -WorkflowFileName $workflowFileName `
            -WorkflowSearchPattern "${env:PR_TITLE}" `
            -Repository "${env:CI_REPO}" `
            -AccessToken "${env:CI_PR_TOKEN}"

      - name: Add Summary
        if: always()
        run: |
          "# Test Partner Image" >> $env:GITHUB_STEP_SUMMARY
          "| Key | Value |" >> $env:GITHUB_STEP_SUMMARY
          "| :-----------: | :--------: |" >> $env:GITHUB_STEP_SUMMARY
          "| Workflow Run | [Link]($env:CI_WORKFLOW_RUN_URL) |" >> $env:GITHUB_STEP_SUMMARY
          "| Workflow Result | $env:CI_WORKFLOW_RUN_RESULT |" >> $env:GITHUB_STEP_SUMMARY
          "  " >> $env:GITHUB_STEP_SUMMARY

  cancel-workflow:
    runs-on: ubuntu-latest
    needs: wait-completion
    if: cancelled()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cancel workflow
        env:
          CI_PR_TOKEN: ${{ secrets.CI_PR_TOKEN }}
          CI_REPO: ${{ vars.CI_REPO }}
        run: |
          Import-Module ./helpers/GitHubApi.psm1

          $gitHubApi = Get-GithubApi -Repository "${env:CI_REPO}" -AccessToken "${env:CI_PR_TOKEN}"
          $gitHubApi.CancelWorkflowRun("${{ needs.wait-completion.outputs.ci_workflow_run_id }}")
